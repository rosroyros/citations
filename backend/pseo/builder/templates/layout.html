<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ meta_title }}</title>
    <meta name="description" content="{{ meta_description }}">
    <link rel="canonical" href="{{ base_url }}{{ url }}">

    <!-- Schema.org markup -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "HowTo",
        "name": "{{ meta_title }}",
        "description": "{{ meta_description }}"
    }
    </script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/mini-checker.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=Work+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RZWHZQP8N9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RZWHZQP8N9');
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <svg class="logo-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="logo-text">Citation Checker</span>
            </a>
            <nav>
                <ul class="nav-links">
                    <li><a href="/checker/">Check Citations</a></li>
                    <li><a href="/guides/">Guides</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Breadcrumbs -->
    <nav class="breadcrumbs">
        <a href="/">Home</a> >
        <a href="/guides/">Citation Guides</a> >
        <span class="current">{{ breadcrumb_title or meta_title }}</span>
    </nav>

    <!-- Main Content -->
    <div class="content-wrapper {% if page_type %}{{ page_type }}{% endif %}">
        <main class="main-content">
            {{ content | safe }}

            <!-- MiniChecker CTA placements (will be populated by JavaScript) -->
            <div class="cta-placement" id="mini-checker-1">
                <h4>Quick Check Your Citation</h4>
                <p>Validate APA formatting instantly</p>
                <!-- MiniChecker component will be mounted here -->
            </div>

            {% if page_type == 'source_type' or not page_type %}
            <!-- Related Resources Grid (for source type pages) -->
            <div class="related-box">
                <h3>Related Source Types</h3>
                <div class="related-grid">
                    {% if related_resources %}
                        {% for resource in related_resources %}
                        <a href="{{ resource.url }}" class="related-link">{{ resource.title }}</a>
                        {% endfor %}
                    {% else %}
                        <a href="/how-to-cite-book-apa/" class="related-link">üìñ How to Cite Books</a>
                        <a href="/how-to-cite-website-apa/" class="related-link">üåê How to Cite Websites</a>
                        <a href="/how-to-cite-newspaper-apa/" class="related-link">üì∞ How to Cite Newspapers</a>
                        <a href="/how-to-cite-chapter-apa/" class="related-link">üìö How to Cite Book Chapters</a>
                        <a href="/how-to-cite-dataset-apa/" class="related-link">üíæ How to Cite Datasets</a>
                        <a href="/guide/apa-7th-edition/" class="related-link">üìã Complete APA Guide</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </main>

        {% if page_type == 'mega_guide' %}
        <!-- Sidebar (for mega guide pages only) -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>Related Guides</h3>
                {% if related_resources %}
                <ul>
                    {% for resource in related_resources %}
                    <li><a href="{{ resource.url }}">{{ resource.title }}</a></li>
                    {% endfor %}
                </ul>
                {% else %}
                <ul>
                    <li><a href="/guide/apa-7th-edition/">üìÑ APA 7th Edition Guide</a></li>
                    <li><a href="/how-to-cite-journal-article-apa/">üì∞ Journal Articles</a></li>
                    <li><a href="/how-to-cite-book-apa/">üìñ Books in APA</a></li>
                    <li><a href="/how-to-cite-website-apa/">üåê Websites in APA</a></li>
                </ul>
                {% endif %}
            </div>

            <div class="sidebar-section">
                <h3>Quick Tools</h3>
                <ul>
                    <li><a href="/">Citation Checker</a></li>
                    <li><a href="/generator/">Format Generator</a></li>
                    <li><a href="/tools/style-comparison/">Style Comparison</a></li>
                </ul>
            </div>

            <div class="sidebar-section sidebar-pro-tip">
                <h3>üí° Pro Tip</h3>
                <p>Check your citations as you write, not all at once at the end. This saves time and prevents errors from accumulating.</p>
            </div>

            <div class="sidebar-section">
                <h3>Page Info</h3>
                <p><strong>Word count:</strong> {{ word_count or 'Unknown' }}</p>
                <p><strong>Reading time:</strong> {{ reading_time or 'Unknown' }}</p>
                <p><strong>Last updated:</strong> {{ last_updated or 'Unknown' }}</p>
            </div>
        </aside>
        {% endif %}
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="site-footer-content">
            <p>&copy; 2024 Citation Checker. Last updated: {{ last_updated or '2024' }}</p>
            <p class="footer-tagline">Built for researchers, by researchers</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        // Polyfill for process.env (needed for React development build)
        window.process = { env: { NODE_ENV: 'production' } };
    </script>
    <script>
        // Helper function to extract source type from URL
        function getSourceTypeFromURL() {
            const path = window.location.pathname;

            // Extract source type from URL patterns like /how-to-cite-[source]-[style]/
            const match = path.match(/\/how-to-cite-([^-]+)-/);
            if (match && match[1]) {
                return match[1].toLowerCase();
            }

            // Extract source type from specific source URLs like /source/[source-type]/
            const sourceMatch = path.match(/\/source\/([^\/]+)/);
            if (sourceMatch && sourceMatch[1]) {
                return sourceMatch[1].toLowerCase();
            }

            return 'unknown';
        }

        // Citation checking function for static MiniChecker components in markdown
        async function checkCitation(button) {
            // Find the textarea within the same mini-checker container
            const miniChecker = button.closest('.mini-checker');
            const textarea = miniChecker ? miniChecker.querySelector('textarea') : null;

            if (!textarea) {
                console.error('Could not find textarea for mini-checker');
                alert('Error: Could not find citation input field.');
                return;
            }

            const citation = textarea.value.trim();

            if (!citation) {
                alert('Please enter a citation to check.');
                return;
            }

            // Track mini_checker_opened event
            if (typeof gtag === 'function') {
                const pageType = document.body.className.includes('source-type') ? 'source_type' :
                               document.body.className.includes('mega-guide') ? 'mega_guide' : 'general';
                const sourceType = getSourceTypeFromURL();

                gtag('event', 'mini_checker_opened', {
                    page_type: pageType,
                    source_type: sourceType
                });
            }

            // Show loading state
            button.disabled = true;
            button.textContent = 'Checking...';

            // Remove previous results
            const existingResults = miniChecker.querySelector('.mini-checker-results');
            if (existingResults) {
                existingResults.remove();
            }

            try {
                // Call validation API
                const response = await fetch('/api/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        citations: citation,
                        style: 'apa7',
                    }),
                });

                if (!response.ok) {
                    throw new Error('Validation failed');
                }

                const data = await response.json();

                // Extract errors from response (API returns {results: [{errors: [...]}]})
                const errors = data.results && data.results[0] && data.results[0].errors ? data.results[0].errors : [];

                // Track mini_checker_validated event
                if (typeof gtag === 'function') {
                    const pageType = document.body.className.includes('source-type') ? 'source_type' :
                                   document.body.className.includes('mega-guide') ? 'mega_guide' : 'general';
                    const sourceType = getSourceTypeFromURL();

                    gtag('event', 'mini_checker_validated', {
                        page_type: pageType,
                        source_type: sourceType,
                        validation_result: errors.length > 0 ? 'errors_found' : 'valid',
                        errors_count: errors.length
                    });
                }

                // Show results inline
                const resultsDiv = document.createElement('div');
                resultsDiv.className = 'mini-checker-results';
                resultsDiv.style.marginTop = '1rem';
                resultsDiv.style.padding = '1rem';
                resultsDiv.style.backgroundColor = '#f9fafb';
                resultsDiv.style.borderRadius = '0.5rem';
                resultsDiv.style.border = '1px solid #e5e7eb';

                if (errors.length > 0) {
                    resultsDiv.innerHTML = '<h5 style="color: #dc2626; margin-bottom: 0.5rem;">‚ùå Issues Found:</h5><ul style="margin: 0; padding-left: 1.5rem;">' +
                        errors.map(err => '<li style="color: #dc2626; margin-bottom: 0.25rem;"><strong>' + err.component + ':</strong> ' + err.problem + '</li>').join('') +
                        '</ul><p style="margin-top: 0.75rem;"><a href="/" style="color: #3b82f6;">Check more citations ‚Üí</a></p>';
                } else {
                    resultsDiv.innerHTML = '<p style="color: #059669; margin: 0;">‚úÖ Citation looks good!</p><p style="margin-top: 0.75rem;"><a href="/" style="color: #3b82f6;">Check more citations ‚Üí</a></p>';
                }

                miniChecker.appendChild(resultsDiv);

            } catch (err) {
                console.error('Validation error:', err);
                alert('Error checking citation. Please try again or use the main checker.');
            } finally {
                // Reset button
                button.disabled = false;
                button.textContent = button.getAttribute('data-original-text') || 'Check Citation';
            }
        }

        // Initialize static mini-checkers when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const miniCheckers = document.querySelectorAll('.mini-checker');
            console.log('Found static mini-checkers:', miniCheckers.length);

            miniCheckers.forEach(function(miniChecker, index) {
                const button = miniChecker.querySelector('button');
                const textarea = miniChecker.querySelector('textarea');

                console.log(`Mini-checker ${index + 1}:`, {
                    button: !!button,
                    textarea: !!textarea
                });

                if (button && textarea) {
                    // Store original button text
                    button.setAttribute('data-original-text', button.textContent);

                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Mini-checker button clicked');
                        checkCitation(button);
                    });

                    // Add Enter key support
                    textarea.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && e.ctrlKey) {
                            e.preventDefault();
                            checkCitation(button);
                        }
                    });
                } else {
                    console.error('Mini-checker missing button or textarea:', {
                        button: !!button,
                        textarea: !!textarea
                    });
                }
            });
        });
    </script>
    <script src="/assets/js/mini-checker.js"></script>
    <script>
        // Mount MiniChecker components
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof mountMiniChecker === 'function') {
                // Mount main MiniChecker
                mountMiniChecker('mini-checker-1', {
                    placeholder: "Enter your citation here...",
                    contextType: "mega-guide",
                    onFullChecker: function() {
                        window.location.href = '/checker/';
                    }
                });

                // Mount intro section MiniChecker
                mountMiniChecker('mini-checker-intro', {
                    placeholder: "Smith, J. A. (2020). Article title goes here. Journal Name, 15(2), 123-145. https://doi.org/10.1234/example",
                    contextType: "mega-guide",
                    onFullChecker: function() {
                        window.location.href = '/checker/';
                    }
                });

                // Mount test section MiniChecker
                mountMiniChecker('mini-checker-test', {
                    placeholder: "Paste your citation here...",
                    contextType: "mega-guide",
                    onFullChecker: function() {
                        window.location.href = '/checker/';
                    }
                });
            }
        });
    </script>
</body>
</html>