<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit System Test</title>
</head>
<body>
    <h1>Credit System Test</h1>
    <button onclick="testCreditStorage()">Test Credit Storage</button>
    <button onclick="clearStorage()">Clear Storage</button>
    <div id="results"></div>

    <script type="module">
        // Copy the credit storage functions here for testing
        const TOKEN_KEY = 'citation_checker_token';
        const FREE_USAGE_KEY = 'citation_checker_free_used';

        const getToken = () => {
            try {
                return localStorage.getItem(TOKEN_KEY);
            } catch (e) {
                console.error('Failed to get token:', e);
                return null;
            }
        };

        const saveToken = (token) => {
            try {
                localStorage.setItem(TOKEN_KEY, token);
            } catch (e) {
                console.error('Failed to save token:', e);
            }
        };

        const getFreeUsage = () => {
            try {
                return parseInt(localStorage.getItem(FREE_USAGE_KEY) || '0', 10);
            } catch (e) {
                console.error('Failed to get free usage:', e);
                return 0;
            }
        };

        const incrementFreeUsage = (count) => {
            try {
                const current = getFreeUsage();
                localStorage.setItem(FREE_USAGE_KEY, String(current + count));
                return current + count;
            } catch (e) {
                console.error('Failed to increment free usage:', e);
                return current;
            }
        };

        const clearToken = () => {
            try {
                localStorage.removeItem(TOKEN_KEY);
            } catch (e) {
                console.error('Failed to clear token:', e);
            }
        };

        const resetFreeUsage = () => {
            try {
                localStorage.removeItem(FREE_USAGE_KEY);
            } catch (e) {
                console.error('Failed to reset free usage:', e);
            }
        };

        window.testCreditStorage = () => {
            const results = document.getElementById('results');

            // Test 1: Clear and start fresh
            resetFreeUsage();
            clearToken();

            let output = '<h2>Testing Credit System</h2>';

            // Test 2: Check initial state
            let freeUsed = getFreeUsage();
            let token = getToken();
            output += `<p>Initial state - Free used: ${freeUsed}, Token: ${token}</p>`;

            // Test 3: Simulate 5 citations
            const newCount = incrementFreeUsage(5);
            output += `<p>After 5 citations - Free used: ${newCount}</p>`;

            // Test 4: Simulate 5 more citations (total 10)
            const totalCount = incrementFreeUsage(5);
            output += `<p>After 10 total citations - Free used: ${totalCount}</p>`;

            // Test 5: Check if limit reached (>= 10)
            const limitReached = getFreeUsage() >= 10;
            output += `<p>Limit reached: ${limitReached}</p>`;

            // Test 6: Test token functionality
            saveToken('test-token-123');
            const savedToken = getToken();
            output += `<p>Saved token: ${savedToken}</p>`;

            // Test 7: Clear token and check
            clearToken();
            const clearedToken = getToken();
            output += `<p>After clearing token: ${clearedToken}</p>`;

            results.innerHTML = output;
        };

        window.clearStorage = () => {
            resetFreeUsage();
            clearToken();
            document.getElementById('results').innerHTML = '<p>Storage cleared</p>';
        };
    </script>
</body>
</html>